
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="fr">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>watchdog &#8212; Bibliothèques Python 0.1.1 documentation</title>
    
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.1.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/translations.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Recherche" href="../search.html" />
    <link rel="next" title="À propos de ce livre" href="../misc/about.html" />
    <link rel="prev" title="sphinx" href="../sphinx/index.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="watchdog">
<span id="watchdog-tutorial"></span><h1><code class="docutils literal"><span class="pre">watchdog</span></code><a class="headerlink" href="#watchdog" title="Permalink to this headline">¶</a></h1>
<p>Par Paul Jeanbourquin <a class="footnote-reference" href="#pj" id="id1">[1]</a></p>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>Watchdog est une librairie permettant l’utilisation d’événemement du système de f
ichier (création de fichier, modification, …).</p>
<p>Cette librairie peut-être utilisée (par exemple) pour la mise en place d’un scanner de fichier dynamique
(exemple Scanner multimédia)
ou pour la mise en place d’un système d’audit des événements sur les fichiers.
Dans le cadre de cet article, notre fils rouge sera la création d’un programme d’audit
des événements émis par les fichiers de musiques.</p>
</div>
<div class="section" id="fonctionnement">
<h2>Fonctionnement<a class="headerlink" href="#fonctionnement" title="Permalink to this headline">¶</a></h2>
<div class="section" id="traitement-de-l-evenement">
<h3>Traitement de l’événement<a class="headerlink" href="#traitement-de-l-evenement" title="Permalink to this headline">¶</a></h3>
<p>Pour intercepter les événements il faut créer une classe qui va contenir les fonctions par événements.</p>
<p>Un exemple d’une classe pour un système d’audit :</p>
<div class="highlight-python3"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">watchdog.events</span> <span class="k">import</span> <span class="n">FileSystemEventHandler</span>

<span class="k">class</span> <span class="nc">AuditHandler</span><span class="p">(</span><span class="n">FileSystemEventHandler</span><span class="p">):</span>

      <span class="k">def</span> <span class="nf">on_modified</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
          <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Le fichier </span><span class="si">%s</span><span class="s2"> a été modifié&quot;</span> <span class="o">%</span> <span class="n">event</span><span class="o">.</span><span class="n">src_path</span><span class="p">)</span>

      <span class="k">def</span> <span class="nf">on_created</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="p">):</span>
          <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Le fichier </span><span class="si">%s</span><span class="s2"> a été créé&quot;</span> <span class="o">%</span> <span class="n">event</span><span class="o">.</span><span class="n">src_path</span><span class="p">)</span>

      <span class="k">def</span> <span class="nf">on_deleted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="p">):</span>
          <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Le fichier </span><span class="si">%s</span><span class="s2"> a été supprimé&quot;</span> <span class="o">%</span> <span class="n">event</span><span class="o">.</span><span class="n">src_path</span><span class="p">)</span>
</pre></div>
</div>
<p>Liste d’événements interceptable :</p>
<table border="1" class="docutils">
<colgroup>
<col width="26%" />
<col width="74%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Nom</th>
<th class="head">Déclanchement</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><code class="docutils literal"><span class="pre">on_modified</span></code></td>
<td>Modification d’un fichier / dossier</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">on_created</span></code></td>
<td>Création d’un fichier / dossier</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">on_deleted</span></code></td>
<td>Suppression d’un fichier / dossier</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">on_moved</span></code></td>
<td>Déplacement / renomage d’un fichier / dossier</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">on_any_event</span></code></td>
<td>Dans tous les cas ci-dessus</td>
</tr>
</tbody>
</table>
<p>L’objet <code class="docutils literal"><span class="pre">event</span></code> est une instance de la classe <a class="reference external" href="http://pythonhosted.org/watchdog/api.html#watchdog.events.FileSystemEvent" title="(in watchdog v0.8.2)"><code class="xref py py-class docutils literal"><span class="pre">watchdog.events.FileSystemEvent</span></code></a>.
Cette classe est dérivée pour chaque type d’événement. Elle contient les attributs suivant :</p>
<table border="1" class="docutils">
<colgroup>
<col width="22%" />
<col width="78%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Attribut</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><code class="docutils literal"><span class="pre">event_type</span></code></td>
<td>Le type d’événement en string</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">is_directory</span></code></td>
<td>Boolean signalant si l’événement s’applique à un dossier</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">src_path</span></code></td>
<td>Chemin du fichier ayant lancé l’événement</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">dest_path</span></code></td>
<td>Fichier de destination (Uniquement lors d’un <code class="docutils literal"><span class="pre">on_moved</span></code>)</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="interception-de-l-evenement">
<h3>Interception de l’événement<a class="headerlink" href="#interception-de-l-evenement" title="Permalink to this headline">¶</a></h3>
<p>La classe doit, ensuite, être liée à un observateur.
C’est ici que nous spécifierons le dossier qui devra être observé.</p>
<div class="highlight-python3"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">eventhandler</span>
<span class="kn">from</span> <span class="nn">watchdog.observers</span> <span class="k">import</span> <span class="n">Observer</span>

<span class="c1"># Création de l&#39;observeur</span>
<span class="n">observer</span> <span class="o">=</span> <span class="n">Observer</span><span class="p">()</span>
<span class="c1"># Création du lien</span>
<span class="n">observer</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">eventhandler</span><span class="o">.</span><span class="n">AuditHandler</span><span class="p">(),</span> <span class="n">path</span><span class="o">=</span><span class="s1">&#39;U:&#39;</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1"># Démarrage de l&#39;observateur</span>
<span class="n">observer</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</pre></div>
</div>
<p>Dans ce cas, l’observateur surveille le dossier <code class="docutils literal"><span class="pre">&quot;U:&quot;</span></code> de manière récursive.</p>
</div>
<div class="section" id="bloquer-le-script">
<h3>Bloquer le script<a class="headerlink" href="#bloquer-le-script" title="Permalink to this headline">¶</a></h3>
<p>Un observateur étant lancé dans un thread séparé, il faut bloquer l’éxecution du script.
Mais, nous aimerions aussi pouvoir fermer le script par interruption du clavier.
La fermeture de l’observateur doit aussi être douce. Pour ce faire nous utiliserons le code ci-dessous.</p>
<div class="highlight-python3"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>

<span class="k">try</span><span class="p">:</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span> <span class="c1"># Boucle infinie bloquant l&#39;execution du script</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># petite attente d&#39;une milliseconde</span>
<span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span> <span class="c1"># Prise en charge de l&#39;interuption par le clavier</span>
    <span class="n">observer</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span> <span class="c1"># Arret de l&#39;observateur</span>
<span class="n">observer</span><span class="o">.</span><span class="n">join</span><span class="p">()</span> <span class="c1"># Attend que l&#39;observateur se soit bien fermé</span>
</pre></div>
</div>
<div class="admonition-todo admonition" id="index-0">
<p class="first admonition-title">Todo</p>
<p class="last">Votre exemple n’est pas super bon. En tant qu’expert de la programmation
concurrente vous remarquerez que qu’il y a une opération bloquante dans ce
bout de code. La placer dans le <code class="docutils literal"><span class="pre">try</span></code>/<code class="docutils literal"><span class="pre">except</span></code> vous permet d’éviter
ce très vilain <code class="docutils literal"><span class="pre">while</span> <span class="pre">True</span></code>.</p>
</div>
</div>
<div class="section" id="filtrage">
<h3>Filtrage<a class="headerlink" href="#filtrage" title="Permalink to this headline">¶</a></h3>
<p>Il est possible de filtrer les fichiers sur lesquelles les events sont interceptés,
ce qui est utile si l’on souhaite (par exemple) traiter que certain type de fichiers (par ex. les .mp3).</p>
<p>Pour ce faire, il faut utiliser une autre classe de base pour la classe de traitement.
Deux classes dérivant de <a class="reference external" href="http://pythonhosted.org/watchdog/api.html#watchdog.events.FileSystemEventHandler" title="(in watchdog v0.8.2)"><code class="xref py py-class docutils literal"><span class="pre">watchdog.events.FileSystemEventHandler</span></code></a> sont fournies (liste dans le tableau ci-dessous).</p>
<table border="1" class="docutils">
<colgroup>
<col width="42%" />
<col width="58%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Nom</th>
<th class="head">Utilisation</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><code class="docutils literal"><span class="pre">FileSystemEventHandler</span></code></td>
<td>Handler de base (sans filtre)</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">PatternMatchingEventHandler</span></code></td>
<td>Handler utilisant un pattern pour filtrer</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">RegexMatchingEventHandler</span></code></td>
<td>Handler utilisant un regex pour filtrer</td>
</tr>
</tbody>
</table>
<p>L’utilisation de la version avec les patterns étant la même que celle avec les regexes,
nous utiliserons la version patterns dans la suite.
Par exemple si l’on souhaite reprendre le code du programme d’audit fait plus haut mais,
qui s’occupe que des fichiers de musique (.mp3, .flac, .wav).</p>
<div class="highlight-python3"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">watchdog.events</span> <span class="k">import</span> <span class="n">PatternMatchingEventHandler</span>

<span class="k">class</span> <span class="nc">AuditHandlerMusic</span><span class="p">(</span><span class="n">PatternMatchingEventHandler</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">on_modified</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Le fichier </span><span class="si">%s</span><span class="s2"> a été modifié&quot;</span> <span class="o">%</span> <span class="n">event</span><span class="o">.</span><span class="n">src_path</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">on_created</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Le fichier </span><span class="si">%s</span><span class="s2"> a été créé&quot;</span> <span class="o">%</span> <span class="n">event</span><span class="o">.</span><span class="n">src_path</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">on_deleted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Le fichier </span><span class="si">%s</span><span class="s2"> a été supprimé&quot;</span> <span class="o">%</span> <span class="n">event</span><span class="o">.</span><span class="n">src_path</span><span class="p">)</span>
</pre></div>
</div>
<p>La classe de traitement ne change quasiment pas la seule différence est le changement de la classe de base.
La principale différence ce trouvera au moment de l’instantation de l’objet.</p>
<div class="highlight-python3"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">eventhandler</span>
<span class="kn">from</span> <span class="nn">watchdog.observers</span> <span class="k">import</span> <span class="n">Observer</span>

<span class="n">observer</span> <span class="o">=</span> <span class="n">Observer</span><span class="p">()</span>
<span class="n">handler</span> <span class="o">=</span> <span class="n">eventhandler</span><span class="o">.</span><span class="n">AuditHandlerMusic</span><span class="p">(</span><span class="n">patterns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;*.mp3&quot;</span><span class="p">,</span> <span class="s2">&quot;*.wav&quot;</span><span class="p">,</span> <span class="s2">&quot;*.flac&quot;</span><span class="p">])</span>
<span class="n">observer</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s1">&#39;U:&#39;</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">observer</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</pre></div>
</div>
<p>Ici nous avons instancié l’objet avant de le passer en arguments à la fonction.
Nous spécifions aussi un premier arguement du constructeur
qui se trouve dans ce cas être les patterns à traiter.</p>
<p>Les autres arguments possible sont dans l’ordre :</p>
<table border="1" class="docutils">
<colgroup>
<col width="29%" />
<col width="14%" />
<col width="57%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Noms</th>
<th class="head">Default</th>
<th class="head">Utilisation</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><code class="docutils literal"><span class="pre">patterns</span></code>/<code class="docutils literal"><span class="pre">regexes</span></code></td>
<td><code class="docutils literal"><span class="pre">None</span></code>/<code class="docutils literal"><span class="pre">[&quot;.*&quot;]</span></code></td>
<td>Spécifie les patterns (respectivement regexes) à traiter</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">ignore_patterns</span></code> / <code class="docutils literal"><span class="pre">ignore_regexes</span></code></td>
<td><code class="docutils literal"><span class="pre">None</span></code>/<code class="docutils literal"><span class="pre">[]</span></code></td>
<td>Spécifie les patterns (respectivement regexes) à ignorer</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">ignore_directories</span></code></td>
<td><code class="docutils literal"><span class="pre">False</span></code></td>
<td>Si mis à <code class="docutils literal"><span class="pre">True</span></code> ignore les dossiers</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">case_sensitive</span></code></td>
<td><code class="docutils literal"><span class="pre">False</span></code></td>
<td>Si mis à <code class="docutils literal"><span class="pre">True</span></code> rend le patterns (respectivement regex) sensible à la casse</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="conclusion">
<h2>Conclusion<a class="headerlink" href="#conclusion" title="Permalink to this headline">¶</a></h2>
<p>En conclusion, la bibliothèque watchdog permet d’utiliser des événements, en provenance du système de fichiers, d’une manière facile et efficace.
Watchdog permet aussi de filtrer les fichiers / dossiers émettant un événement.
Cette bibliothèque permet aussi une grande réusabilité du code grâce, entre autre, à l’utilisation de classe pour le traitement des événements.</p>
<table class="docutils footnote" frame="void" id="pj" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td>&lt;<a class="reference external" href="mailto:paul&#46;jeanbourquin&#37;&#52;&#48;he-arc&#46;ch">paul<span>&#46;</span>jeanbourquin<span>&#64;</span>he-arc<span>&#46;</span>ch</a>&gt;</td></tr>
</tbody>
</table>
</div>
<div class="section" id="bibliographie">
<h2>Bibliographie<a class="headerlink" href="#bibliographie" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>watchdog documentation : <a class="reference external" href="http://pythonhosted.org/watchdog/">http://pythonhosted.org/watchdog/</a></li>
<li>Tutoriel d’utilisation de watchdog : <a class="reference external" href="http://sametmax.com/reagir-a-un-changement-sur-un-fichier-avec-watchdog/">http://sametmax.com/reagir-a-un-changement-sur-un-fichier-avec-watchdog/</a></li>
</ul>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table des Matières</a></h3>
  <ul>
<li><a class="reference internal" href="#"><code class="docutils literal"><span class="pre">watchdog</span></code></a><ul>
<li><a class="reference internal" href="#introduction">Introduction</a></li>
<li><a class="reference internal" href="#fonctionnement">Fonctionnement</a><ul>
<li><a class="reference internal" href="#traitement-de-l-evenement">Traitement de l’événement</a></li>
<li><a class="reference internal" href="#interception-de-l-evenement">Interception de l’événement</a></li>
<li><a class="reference internal" href="#bloquer-le-script">Bloquer le script</a></li>
<li><a class="reference internal" href="#filtrage">Filtrage</a></li>
</ul>
</li>
<li><a class="reference internal" href="#conclusion">Conclusion</a></li>
<li><a class="reference internal" href="#bibliographie">Bibliographie</a></li>
</ul>
</li>
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
      <li>Previous: <a href="../sphinx/index.html" title="Chapitre précédent"><code class="docutils literal"><span class="pre">sphinx</span></code></a></li>
      <li>Next: <a href="../misc/about.html" title="Chapitre suivant">À propos de ce livre</a></li>
  </ul></li>
</ul>
</div>
  <div role="note" aria-label="source link">
    <h3>Cette page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/watchdog/index.rst.txt"
            rel="nofollow">Montrer le code source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Recherche rapide</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2016-2017, HE-Arc.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.6.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
      |
      <a href="../_sources/watchdog/index.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>